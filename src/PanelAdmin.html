<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n - DGAD</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; text-align: center; }
    .header h1 { color: #333; font-size: 32px; margin-bottom: 10px; }
    .header p { color: #666; font-size: 16px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card .icon { font-size: 40px; margin-bottom: 15px; }
    .stat-card h3 { color: #666; font-size: 14px; font-weight: normal; margin-bottom: 10px; }
    .stat-card .number { font-size: 36px; font-weight: bold; color: #333; }
    .main-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #eee; }
    .tab { padding: 15px 30px; background: none; border: none; font-size: 16px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.3s ease; border-bottom: 3px solid transparent; }
    .tab:hover { color: #667eea; }
    .tab.active { color: #667eea; border-bottom-color: #667eea; }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    .form-group input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
    .form-group input:focus { outline: none; border-color: #667eea; }
    .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 10px; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
    .btn-secondary { background: #f0f0f0; color: #333; font-size: 14px; padding: 8px 16px; }
    .btn-secondary:hover { background: #e0e0e0; }
    .qr-result { margin-top: 30px; padding: 30px; background: #f8f9fa; border-radius: 12px; text-align: center; display: none; }
    .qr-result.show { display: block; animation: fadeIn 0.5s ease; }
    .qr-result img { max-width: 300px; margin: 20px auto; border: 5px solid white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .qr-result .url-box { background: white; padding: 15px; border-radius: 8px; margin: 20px 0; word-break: break-all; font-family: monospace; font-size: 12px; color: #666; }
    .events-list { display: grid; gap: 15px; }
    .event-card { background: #f8f9fa; padding: 20px; border-radius: 10px; transition: all 0.3s ease; }
    .event-card:hover { background: #e9ecef; }
    .event-info h4 { color: #333; margin-bottom: 5px; }
    .event-info p { color: #666; font-size: 14px; }
    .event-qr-section { margin-top: 15px; padding-top: 15px; border-top: 2px dashed #ddd; }
    .qr-preview { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    .qr-preview img { width: 150px; height: 150px; border: 3px solid white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .qr-actions { flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .loading { display: none; text-align: center; padding: 20px; }
    .loading.show { display: block; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
    .alert.show { display: block; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error   { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .quick-action-btn { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-align: center; }
    .quick-action-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
    .quick-action-btn .icon { font-size: 24px; display: block; margin-bottom: 10px; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 8px; }
    .badge-success { background: #4CAF50; color: white; }
    .badge-warning { background: #FF9800; color: white; }
    .btn-logout-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
    .btn-logout { padding: 12px 24px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3); }
    .btn-logout:hover { background: #d32f2f; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(244, 67, 54, 0.4); }
  </style>
</head>

<body style="display:none;" id="adminBody">
  <div id="logoutContainer" class="btn-logout-container" style="display: none;">
    <button class="btn-logout" onclick="cerrarSesion()">Logout</button>
  </div>

  <div class="container">
    <div class="header">
      <h1>üéì Panel de Administraci√≥n DGAD</h1>
      <p>Sistema de Registro y Asistencia Cloud</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card"><div class="icon">üìä</div><h3>Total de Registros</h3><div class="number" id="totalRegistros">-</div></div>
      <div class="stat-card"><div class="icon">‚úÖ</div><h3>Presentes Hoy</h3><div class="number" id="presentesHoy">-</div></div>
      <div class="stat-card"><div class="icon">üìÖ</div><h3>Registros Hoy</h3><div class="number" id="registrosHoy">-</div></div>
      <div class="stat-card"><div class="icon">üéØ</div><h3>Total de Eventos</h3><div class="number" id="totalEventos">-</div></div>
    </div>

    <div class="main-content">
      <div class="quick-actions">
        <button class="quick-action-btn" onclick="abrirGoogleForm()"><span class="icon">üìù</span>Abrir Google Form</button>
        <button class="quick-action-btn" onclick="mostrarQRGoogleForm()"><span class="icon">üì±</span>QR del Form</button>
        <button class="quick-action-btn" onclick="generarReporteSemanal()"><span class="icon">üìß</span>Reporte Semanal</button>
        <button class="quick-action-btn" onclick="generarReporteMensual()"><span class="icon">üìà</span>Reporte Mensual</button>
        <button class="quick-action-btn" onclick="abrirLookerStudio()"><span class="icon">üìä</span>Ver Dashboard</button>
        <button class="quick-action-btn" onclick="abrirSpreadsheet()"><span class="icon">üìã</span>Abrir Sheets</button>
        <button class="quick-action-btn" onclick="resetearHoja()" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">
          <span class="icon">üîÑ</span>Resetear Datos
        </button>
      </div>

      <div id="alertSuccess" class="alert alert-success"></div>
      <div id="alertError"   class="alert alert-error"></div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('generar', event)">üîó Generar QR</button>
        <button class="tab" onclick="switchTab('eventos', event)">üìÖ Mis Eventos y QRs</button>
        <button class="tab" onclick="switchTab('configuracion', event)">‚öôÔ∏è Configuraci√≥n</button>
      </div>

      <!-- TAB: Generar QR -->
      <div id="tab-generar" class="tab-content active">
        <h2 style="margin-bottom: 20px;">Generar C√≥digo QR para Evento</h2>
        <form id="formQR" onsubmit="return generarQR(event);">
          <div class="form-group"><label for="nombreEvento">Nombre del Evento *</label><input type="text" id="nombreEvento" placeholder="Ej: Taller de Apps Script Avanzado" required></div>
          <div class="form-group"><label for="idEvento">ID del Evento *</label><input type="text" id="idEvento" placeholder="Ej: TALLER-2026-001" required></div>
          <div class="form-group"><label for="fechaEvento">Fecha del Evento *</label><input type="date" id="fechaEvento" required></div>
          <button type="submit" class="btn btn-primary"><span>üéØ</span>Crear Evento y Generar QR</button>
        </form>
        <div id="loading" class="loading"><div class="spinner"></div><p>Creando evento y generando c√≥digo QR...</p></div>
        <div id="qrResult" class="qr-result">
          <h3 style="color: #667eea; margin-bottom: 20px;">‚úì Evento Creado y QR Generado</h3>
          <div id="qrEventoNombre" style="font-size: 20px; font-weight: bold; margin-bottom: 10px;"></div>
          <div id="qrEventoId" style="color: #666; margin-bottom: 20px;"></div>
          <img id="qrImage" src="" alt="C√≥digo QR">
          <div class="url-box"><strong>URL del evento:</strong><br><span id="qrUrl"></span></div>
          <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
            <button class="btn btn-primary" onclick="descargarQR()">üì• Descargar QR</button>
            <button class="btn btn-secondary" onclick="copiarURL()">üìã Copiar URL</button>
            <button class="btn btn-secondary" onclick="compartirWhatsApp()">üí¨ WhatsApp</button>
            <button class="btn btn-secondary" onclick="compartirEmail()">üìß Email</button>
            <button class="btn btn-secondary" onclick="compartirTelegram()">‚úàÔ∏è Telegram</button>
          </div>
        </div>
      </div>

      <!-- TAB: Eventos -->
      <div id="tab-eventos" class="tab-content">
        <h2 style="margin-bottom: 20px;">üìÖ Mis Eventos y C√≥digos QR</h2>
        <div id="eventosList" class="events-list"><p style="text-align: center; color: #999;">Cargando eventos...</p></div>
      </div>

      <!-- TAB: Configuraci√≥n -->
      <div id="tab-configuracion" class="tab-content">
        <h2 style="margin-bottom: 20px;">Configuraci√≥n del Sistema</h2>
        <div class="form-group">
          <label>Estado del Sistema</label>
          <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px;">‚úì Sistema operando correctamente</div>
        </div>
        <div class="form-group">
          <label>Triggers Autom√°ticos</label>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
            <p style="margin-bottom: 10px;">‚úì Confirmaciones por email: <strong>Activo</strong></p>
            <p style="margin-bottom: 10px;">‚úì Reporte semanal: <strong>Lunes 8:00 AM</strong></p>
            <p>‚úì Reporte mensual: <strong>D√≠a 1 de cada mes 9:00 AM</strong></p>
          </div>
        </div>
        <button class="btn btn-primary" onclick="reinicializarSistema()">üîÑ Reinicializar Sistema</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // FIREBASE CONFIG
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Reemplaza los valores YOUR_* con los de tu
    // proyecto Firebase (Firebase Console ‚Üí
    // Configuraci√≥n del proyecto ‚Üí Tus apps ‚Üí Web).
    // NO hagas commit con valores reales aqu√≠.
    // Ver README.md para instrucciones completas.
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const firebaseConfig = {
      apiKey:            "YOUR_FIREBASE_API_KEY",
      authDomain:        "YOUR_PROJECT_ID.firebaseapp.com",
      projectId:         "YOUR_PROJECT_ID",
      storageBucket:     "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId:             "YOUR_APP_ID"
    };

    // URL del deployment (Apps Script ‚Üí Implementar ‚Üí Web App ‚Üí URL)
    const DEPLOYMENT_URL = 'YOUR_DEPLOYMENT_URL';

    // URLs de los recursos DGAD
    // Actual√≠zalas despu√©s del setup. Ver README.md.
    const FORM_URL   = 'YOUR_GOOGLE_FORM_URL';
    const SHEETS_URL = 'YOUR_GOOGLE_SHEETS_URL';
    const LOOKER_URL = 'YOUR_LOOKER_STUDIO_URL';
    // ============================================

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    auth.onAuthStateChanged(function(user) {
      if (!user || !user.emailVerified) {
        window.location.replace(DEPLOYMENT_URL);
        return;
      }
      document.getElementById('adminBody').style.display      = 'block';
      document.getElementById('logoutContainer').style.display = 'block';
      inicializarPanel();
    });

    function cerrarSesion() {
      if (!confirm('¬øSeguro que deseas cerrar sesi√≥n?')) return;
      auth.signOut()
        .then(function() { window.location.replace(DEPLOYMENT_URL); })
        .catch(function(error) { alert('Error al cerrar sesi√≥n: ' + error.message); });
    }

    var qrData = null;

    function inicializarPanel() { cargarEstadisticas(); cargarEventos(); }

    function switchTab(tabName, event) {
      document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
      document.querySelectorAll('.tab').forEach(function(b) { b.classList.remove('active'); });
      document.getElementById('tab-' + tabName).classList.add('active');
      if (event && event.target) event.target.classList.add('active');
      if (tabName === 'eventos') cargarEventos();
    }

    function cargarEstadisticas() {
      google.script.run
        .withSuccessHandler(function(s) {
          document.getElementById('totalRegistros').textContent = s.totalRegistros;
          document.getElementById('presentesHoy').textContent   = s.presentesHoy;
          document.getElementById('registrosHoy').textContent   = s.registrosHoy;
          document.getElementById('totalEventos').textContent   = s.totalEventos;
        })
        .withFailureHandler(function(e) { console.error('Error estad√≠sticas:', e); })
        .obtenerEstadisticas();
    }

    function cargarEventos() {
      var lista = document.getElementById('eventosList');
      lista.innerHTML = '<p style="text-align: center; color: #999;">Cargando eventos...</p>';
      google.script.run
        .withSuccessHandler(function(eventos) {
          if (!eventos || eventos.length === 0) { lista.innerHTML = '<p style="text-align: center; color: #999;">No hay eventos registrados.</p>'; return; }
          var html = '';
          for (var i = 0; i < eventos.length; i++) {
            var ev = eventos[i], tieneQR = ev.urlQR && ev.urlQR !== '';
            html += '<div class="event-card"><div class="event-info"><h4>' + (ev.nombre || 'Sin nombre') + '</h4>';
            html += '<p><strong>ID:</strong> ' + (ev.id || 'N/A') + ' | <strong>Fecha:</strong> ' + formatearFecha(ev.fecha);
            if (tieneQR) {
              var qrImg = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + encodeURIComponent(ev.urlQR);
              html += ' <span class="badge badge-success">‚úì Con QR</span></p></div>';
              html += '<div class="event-qr-section"><div class="qr-preview"><img src="' + qrImg + '">';
              html += '<div class="qr-actions">';
              html += '<button class="btn btn-secondary" onclick="descargarQREvento(\'' + qrImg + '\', \'' + ev.id + '\')">üì• Descargar</button>';
              html += '<button class="btn btn-secondary" onclick="copiarURLEvento(\'' + ev.urlQR.replace(/'/g, "\\'") + '\')">üìã Copiar URL</button>';
              html += '<button class="btn btn-secondary" onclick="compartirEventoWhatsApp(\'' + ev.nombre.replace(/'/g, "\\'") + '\', \'' + ev.urlQR.replace(/'/g, "\\'") + '\', \'' + ev.fecha + '\')">üí¨ WhatsApp</button>';
              html += '<button class="btn btn-secondary" onclick="compartirEventoEmail(\'' + ev.nombre.replace(/'/g, "\\'") + '\', \'' + ev.urlQR.replace(/'/g, "\\'") + '\', \'' + ev.fecha + '\')">üìß Email</button>';
              html += '<button class="btn btn-secondary" onclick="compartirEventoTelegram(\'' + ev.nombre.replace(/'/g, "\\'") + '\', \'' + ev.urlQR.replace(/'/g, "\\'") + '\')">‚úàÔ∏è Telegram</button>';
              html += '</div></div></div>';
            } else {
              html += ' <span class="badge badge-warning">‚ö†Ô∏è Sin QR</span></p></div>';
              html += '<div style="margin-top: 15px;"><button class="btn btn-primary" onclick="generarQRParaEvento(\'' + ev.id + '\', \'' + ev.nombre.replace(/'/g, "\\'") + '\', \'' + ev.fecha + '\')">Generar QR</button></div>';
            }
            html += '</div>';
          }
          lista.innerHTML = html;
        })
        .withFailureHandler(function(error) { lista.innerHTML = '<p style="color: #f44336;">Error: ' + error.message + '</p>'; })
        .obtenerEventos();
    }

    function generarQR(event) {
      event.preventDefault();
      var nombre = document.getElementById('nombreEvento').value;
      var id     = document.getElementById('idEvento').value;
      var fecha  = document.getElementById('fechaEvento').value;
      if (!nombre || !id || !fecha) { mostrarAlerta('error', 'Completa todos los campos'); return false; }
      document.getElementById('loading').classList.add('show');
      document.getElementById('qrResult').classList.remove('show');
      google.script.run
        .withSuccessHandler(function(r) {
          document.getElementById('loading').classList.remove('show');
          if (r) {
            qrData = r;
            document.getElementById('qrEventoNombre').textContent = r.nombreEvento;
            document.getElementById('qrEventoId').textContent     = 'ID: ' + r.idEvento;
            document.getElementById('qrImage').src                = r.urlQR;
            document.getElementById('qrUrl').textContent          = r.urlEvento;
            document.getElementById('qrResult').classList.add('show');
            mostrarAlerta('success', '¬°QR generado exitosamente!');
            cargarEventos(); cargarEstadisticas();
          } else { mostrarAlerta('error', 'Error al generar QR'); }
        })
        .withFailureHandler(function(e) { document.getElementById('loading').classList.remove('show'); mostrarAlerta('error', 'Error: ' + e.message); })
        .crearEventoYGenerarQR(nombre, id, fecha);
      return false;
    }

    function generarQRParaEvento(id, nombre, fecha) {
      document.getElementById('idEvento').value     = id;
      document.getElementById('nombreEvento').value = nombre;
      document.getElementById('fechaEvento').value  = fecha;
      switchTab('generar', null);
      setTimeout(function() { document.getElementById('formQR').dispatchEvent(new Event('submit')); }, 500);
    }

    function descargarQR() { if (!qrData) return; var l = document.createElement('a'); l.href = qrData.urlQR; l.download = 'QR_' + qrData.idEvento + '.png'; l.click(); mostrarAlerta('success', 'Descargando...'); }
    function descargarQREvento(url, id) { var l = document.createElement('a'); l.href = url; l.download = 'QR_' + id + '.png'; l.click(); }
    function copiarURL() { if (!qrData) return; navigator.clipboard.writeText(qrData.urlEvento).then(function() { mostrarAlerta('success', '¬°URL copiada!'); }); }
    function copiarURLEvento(url) { navigator.clipboard.writeText(url).then(function() { mostrarAlerta('success', '¬°URL copiada!'); }); }
    function compartirWhatsApp() { if (!qrData) return; window.open('https://wa.me/?text=' + encodeURIComponent('üì± *' + qrData.nombreEvento + '*\n\n' + qrData.urlEvento + '\n\nFecha: ' + formatearFecha(qrData.fecha)), '_blank'); }
    function compartirEmail() { if (!qrData) return; window.location.href = 'mailto:?subject=' + encodeURIComponent('Registro: ' + qrData.nombreEvento) + '&body=' + encodeURIComponent(qrData.urlEvento); }
    function compartirTelegram() { if (!qrData) return; window.open('https://t.me/share/url?url=' + encodeURIComponent(qrData.urlEvento), '_blank'); }
    function compartirEventoWhatsApp(n, url, f) { window.open('https://wa.me/?text=' + encodeURIComponent('üì± *' + n + '*\n\n' + url + '\n\nFecha: ' + formatearFecha(f)), '_blank'); }
    function compartirEventoEmail(n, url, f) { window.location.href = 'mailto:?subject=' + encodeURIComponent('Registro: ' + n) + '&body=' + encodeURIComponent(url); }
    function compartirEventoTelegram(n, url) { window.open('https://t.me/share/url?url=' + encodeURIComponent(url), '_blank'); }

    function generarReporteSemanal() { mostrarAlerta('success', 'Generando reporte...'); google.script.run.withSuccessHandler(function() { mostrarAlerta('success', '¬°Reporte enviado!'); }).withFailureHandler(function(e) { mostrarAlerta('error', 'Error: ' + e.message); }).generarReporteSemanal(); }
    function generarReporteMensual() { mostrarAlerta('success', 'Generando reporte...'); google.script.run.withSuccessHandler(function() { mostrarAlerta('success', '¬°Reporte enviado!'); }).withFailureHandler(function(e) { mostrarAlerta('error', 'Error: ' + e.message); }).generarReporteMensual(); }
    function reinicializarSistema() { if (!confirm('¬øSeguro?')) return; google.script.run.withSuccessHandler(function(r) { mostrarAlerta(r.success ? 'success' : 'error', r.message); if (r.success) cargarEstadisticas(); }).withFailureHandler(function(e) { mostrarAlerta('error', 'Error: ' + e.message); }).inicializarSistema(); }

    function abrirGoogleForm() { window.open(FORM_URL, '_blank'); }
    function abrirSpreadsheet() { window.open(SHEETS_URL, '_blank'); }
    function abrirLookerStudio() { window.open(LOOKER_URL, '_blank'); }

    function mostrarQRGoogleForm() {
      var qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(FORM_URL);
      var modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
      modal.innerHTML = '<div style="background:white;padding:30px;border-radius:15px;max-width:500px;text-align:center;">' +
        '<h2 style="color:#667eea;margin-bottom:20px;">QR del Google Form</h2>' +
        '<img src="' + qrUrl + '" style="max-width:300px;margin:20px auto;border:5px solid white;border-radius:12px;">' +
        '<div style="background:#f8f9fa;padding:15px;border-radius:8px;margin:20px 0;word-break:break-all;font-size:12px;">' + FORM_URL + '</div>' +
        '<div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">' +
        '<button class="btn btn-primary" onclick="var l=document.createElement(\'a\');l.href=\'' + qrUrl + '\';l.download=\'QR_Form_DGAD.png\';l.click();">üì• Descargar</button>' +
        '<button class="btn btn-secondary" onclick="navigator.clipboard.writeText(\'' + FORM_URL + '\')">üìã Copiar URL</button>' +
        '<button class="btn btn-secondary" onclick="this.closest(\'div\').parentElement.parentElement.remove()">‚ùå Cerrar</button>' +
        '</div></div>';
      document.body.appendChild(modal);
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
    }

    function resetearHoja() {
      if (!confirm('ADVERTENCIA: Esto eliminar√° TODOS los registros de asistencia. ¬øEst√°s completamente seguro?')) return;
      if (!confirm('Esta acci√≥n NO se puede deshacer. ¬øConfirmas que deseas eliminar todos los datos?')) return;
      mostrarAlerta('success', 'Creando backup y reseteando...');
      google.script.run
        .withSuccessHandler(function(r) {
          mostrarAlerta(r.success ? 'success' : 'error', r.success ? r.message : 'ERROR: ' + r.message);
          if (r.success) setTimeout(cargarEstadisticas, 1000);
        })
        .withFailureHandler(function(e) { mostrarAlerta('error', 'ERROR: ' + e.message); })
        .limpiarHojaRespuestas();
    }

    function mostrarAlerta(tipo, mensaje) {
      var id = tipo === 'success' ? 'alertSuccess' : 'alertError';
      var a  = document.getElementById(id);
      a.textContent = mensaje;
      a.classList.add('show');
      setTimeout(function() { a.classList.remove('show'); }, 5000);
    }

    function formatearFecha(fecha) {
      if (!fecha) return 'N/A';
      try { var d = new Date(fecha); if (isNaN(d.getTime())) return 'N/A'; return d.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' }); }
      catch (e) { return 'N/A'; }
    }
  </script>
</body>
</html>
